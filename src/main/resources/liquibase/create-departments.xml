<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="create-dep_seq" author="Ann" runOnChange="true">
        <createSequence cacheSize="1" cycle="false" sequenceName="dep_seq" dataType="bigint" incrementBy="1" maxValue="9223372036854775807" minValue="1"  startValue="1"/>
    </changeSet>

    <changeSet id="create-departments-table" author="Ann" runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="departments"/>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE departments (
                id BIGINT PRIMARY KEY NOT NULL DEFAULT nextval('dep_seq'),
                department_name VARCHAR(255)
            );
        </sql>
    </changeSet>

    <changeSet id="add-address-department_id" author="Ann" runOnChange="true">
        <sql>
            ALTER TABLE addresses
            ADD COLUMN department_id BIGINT UNIQUE;

            ALTER TABLE addresses
            ADD CONSTRAINT fk_department_address FOREIGN KEY (department_id) REFERENCES departments(id);
        </sql>
    </changeSet>

    <changeSet id="remove-address-course_id" author="Ann" runOnChange="true">
        <sql>
            ALTER TABLE addresses
            DROP CONSTRAINT fk_department_address;

            ALTER TABLE addresses
            DROP COLUMN department_id;
        </sql>
    </changeSet>
    <!--<changeSet id="add-foreign-key-to-students" author="Ann" runOnChange="true">
       <preConditions onFail="MARK_RAN">
           <not>
               <foreignKeyConstraintExists foreignKeyName="fk_departments_student"/>
           </not>
       </preConditions>
       <sql>
           ALTER TABLE students
           ADD CONSTRAINT fk_departments_student FOREIGN KEY (department_id) REFERENCES departments(id);
       </sql>
   </changeSet>

   <changid="add-foreign-key-to-addresses" author="Ann" runOnChange="true">
       <preConditions onFail="MARK_RAN">
           <not>
               <foreignKeyConstraintExists foreignKeyName="fk_departments_addresses"/>
           </not>
       </preConditions>
       <sql>
           ALTER TABLE address_department
           ADD CONSTRAINT fk_departments_addresses FOREIGN KEY (department_id) REFERENCES departments(id);
       </sql>
   </changeSet>-->
    <!--<createTable tableName="departments">
        <column name="id" type="bigint">
            <constraints primaryKey="true" nullable="false"/>
        </column>
        <column name="department_name" type="varchar(255)">
            <constraints nullable="true"/>
        </column>
    </createTable>
</changeSet>

<changeSet id="add-foreign-key-to-students" author="Ann">
    <addForeignKeyConstraint baseTableName="students"
                             baseColumnNames="department_id"
                             referencedTableName="departments"
                             referencedColumnNames="id"
                             constraintName="fk_departments_student"/>
</changeSet>

<changeSet id="add-foreign-key-to-addresses" author="Ann">
    <addForeignKeyConstraint baseTableName="address_department"
                             baseColumnNames="department_id"
                             referencedTableName="departments"
                             referencedColumnNames="id"
                             constraintName="fk_departments_addresses"/>-->

    <changeSet id="create-department-view" author="Ann">
        <preConditions onFail="MARK_RAN">
            <not>
                <viewExists viewName="department_view"/>
            </not>
        </preConditions>
        <createView viewName="department_view">
            SELECT d.id AS department_id,
            d.department_name AS department_name
            FROM departments d
        </createView>
    </changeSet>
</databaseChangeLog>
