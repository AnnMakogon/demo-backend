<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.8.xsd">

    <changeSet id="create-user_seq" author="Ann" runOnChange="true">
        <createSequence cacheSize="1" cycle="false" dataType="bigint" incrementBy="1" maxValue="9223372036854775807" minValue="1" sequenceName="user_seq" startValue="1"/>
    </changeSet>

    <changeSet id="create-users-table" author="Ann" runOnChange="true">
        <preConditions onFail="MARK_RAN">
                <tableExists tableName="users"/>
        </preConditions>
        <!--<createSequence sequenceName="public.user_seq" startValue="1" incrementBy="1"/>-->
        <sql>
            CREATE TABLE users (
                id BIGINT PRIMARY KEY NOT NULL DEFAULT nextval('user_seq'),
                username VARCHAR(255),
                role VARCHAR(255),
                enable BOOLEAN,
                email VARCHAR(255),
                password_id BIGINT UNIQUE,
                CONSTRAINT fk_users_password FOREIGN KEY (password_id) REFERENCES passwords(id)
                <!--student_id BIGINT,
                CONSTRAINT fk_students_users FOREIGN KEY (student_id) REFERENCES students(id)-->
            );
        </sql>
    </changeSet>

    <changeSet id="del-column-enableEmail" author="Ann" runOnChange="true">
        <sql>
            ALTER TABLE users DROP COLUMN enableEmail;
        </sql>
    </changeSet>


    <changeSet id="add-column-enable_Email" author="Ann" runOnChange="true">
        <sql>
            ALTER TABLE users ADD COLUMN enable_Email BOOLEAN;
        </sql>
    </changeSet>




    <!--<createTable tableName="users">
        <column name="id" type="bigint">
            <constraints primaryKey="true" nullable="false"/>
        </column>
        <column name="username" type="varchar(255)">
            <constraints nullable="false"/>
        </column>
        <column name="role" type="varchar(50)">
            <constraints nullable="false"/>
        </column>
        <column name="password_id" type="bigint">
            <constraints nullable="false"/>
        </column>
        <column name="enable" type="boolean">
            <constraints nullable="false"/>
        </column>
        <column name="email" type="varchar(255)">
            <constraints nullable="true"/>
        </column>
        <column name="student_id" type="bigint">
            <constraints nullable="true"/>
        </column>
    </createTable>
</changeSet>

<changeSet id="add-foreign-key-to-passwords" author="Ann">
    <addForeignKeyConstraint baseTableName="users"
                             baseColumnNames="password_id"
                             referencedTableName="passwords"
                             referencedColumnNames="id"
                             constraintName="fk_users_password"/>
</changeSet>

<changeSet id="add-foreign-key-to-students" author="Ann">
    <addForeignKeyConstraint baseTableName="users"
                             baseColumnNames="student_id"
                             referencedTableName="students"
                             referencedColumnNames="id"
                             constraintName="fk_users_students"/>
</changeSet>

    <changeSet id="create-user-view" author="Ann">
        <preConditions onFail="MARK_RAN">
            <not>
                <viewExists viewName="user_view"/>
            </not>
        </preConditions>
        <createView viewName="user_view">
            SELECT u.id AS user_id,
            u.username AS user_username,
            u.role AS user_role,
            p.password AS user_password,
            u.enable AS user_enable,
            u.email AS user_email,
            s.fio AS student_fio
            FROM users u
            LEFT JOIN passwords p ON u.password_id = p.id
            LEFT JOIN students s ON u.id = s.user_id
        </createView>
    </changeSet>-->
</databaseChangeLog>
